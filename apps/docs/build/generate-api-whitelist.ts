/**
 * Generates API whitelist files for the Shiki transformer.
 *
 * These lists must be statically importable (no async/Node.js APIs)
 * because the transformer runs client-side. This script generates
 * the lists from the filesystem at build time.
 *
 * Run manually: pnpm tsx apps/docs/build/generate-api-whitelist.ts
 * Or automatically via the Vite plugin in vite.config.ts
 */

import { readdir, readFile, writeFile } from 'node:fs/promises'
import { dirname, resolve } from 'node:path'
import { fileURLToPath } from 'node:url'

// Types
import type { Plugin } from 'vite'

const __dirname = dirname(fileURLToPath(import.meta.url))
const ROOT = resolve(__dirname, '../../..')
const COMPONENTS_DIR = resolve(ROOT, 'packages/0/src/components')
const COMPOSABLES_DIR = resolve(ROOT, 'packages/0/src/composables')
const OUTPUT_FILE = resolve(__dirname, 'generated/api-whitelist.ts')

/**
 * Discover component directory names (e.g., Avatar, Popover, Dialog)
 */
async function getComponentNames (): Promise<string[]> {
  const names: string[] = []
  const dirs = await readdir(COMPONENTS_DIR)

  for (const dir of dirs) {
    const dirPath = resolve(COMPONENTS_DIR, dir)
    const entries = await readdir(dirPath).catch(() => [])
    const hasVueFiles = entries.some(entry => entry.endsWith('.vue'))
    if (hasVueFiles) {
      names.push(dir)
    }
  }

  return names.toSorted()
}

/**
 * Discover composable names by scanning actual exports from each composable's index.ts.
 *
 * This automatically picks up any exported function matching composable patterns
 * (useX, createX, toX, provideX) without needing manual maintenance.
 *
 * Returns both a set of all names and a mapping from function name to directory name
 * (the directory name is the API cache key).
 */
async function getComposableData (): Promise<{
  names: string[]
  toDir: Record<string, string>
}> {
  const names = new Set<string>()
  const toDir: Record<string, string> = {}
  const dirs = await readdir(COMPOSABLES_DIR)

  // Pattern for composable function names we care about
  const COMPOSABLE_PATTERN = /^(use|create|to|provide)[A-Z]/

  for (const dir of dirs) {
    // Composable directories start with 'use', 'create', or 'to'
    if (!dir.startsWith('use') && !dir.startsWith('create') && !dir.startsWith('to')) continue

    const indexPath = resolve(COMPOSABLES_DIR, dir, 'index.ts')
    const content = await readFile(indexPath, 'utf8').catch(() => null)
    if (!content) continue

    // Find all exported functions matching composable patterns
    // Matches: export function useX, export function createX, etc.
    const exportedFunctions = content.matchAll(/export\s+function\s+(\w+)/g)
    for (const match of exportedFunctions) {
      const fnName = match[1]
      if (COMPOSABLE_PATTERN.test(fnName)) {
        names.add(fnName)
        toDir[fnName] = dir
      }
    }

    // Also add the directory name itself (the primary export)
    names.add(dir)
    toDir[dir] = dir
  }

  // Add trinity return values that are commonly used
  names.add('useContext')
  names.add('provideContext')
  toDir['useContext'] = 'createContext'
  toDir['provideContext'] = 'createContext'

  return {
    names: Array.from(names).toSorted(),
    toDir,
  }
}

/**
 * Generate the whitelist TypeScript file
 */
export async function generateApiWhitelist (): Promise<void> {
  const [components, composableData] = await Promise.all([
    getComponentNames(),
    getComposableData(),
  ])

  const { names: composables, toDir } = composableData

  // Sort toDir entries for stable output
  const toDirEntries = Object.entries(toDir).toSorted((a, b) => a[0].localeCompare(b[0]))

  const content = `/**
 * AUTO-GENERATED - DO NOT EDIT
 *
 * Generated by: apps/docs/build/generate-api-whitelist.ts
 * Source: packages/0/src/components/ and packages/0/src/composables/
 *
 * This file is regenerated on every build. To add new entries,
 * create the component/composable in the source directories.
 */

/**
 * v0 component namespaces that get API hover treatment.
 * Discovered from: packages/0/src/components/
 */
export const V0_COMPONENTS = new Set([
${components.map(c => `  '${c}',`).join('\n')}
])

/**
 * v0 composables with API entries.
 * Discovered from: packages/0/src/composables/
 *
 * Includes directory names and common export variants
 * (useX, createXPlugin, createXContext).
 */
export const V0_COMPOSABLES = new Set([
${composables.map(c => `  '${c}',`).join('\n')}
])

/**
 * Maps composable function names to their directory name (API cache key).
 * Used by the shiki-api-transformer to resolve the correct API page.
 */
export const V0_COMPOSABLE_TO_DIR: Record<string, string> = {
${toDirEntries.map(([fn, dir]) => `  '${fn}': '${dir}',`).join('\n')}
}
`

  // Only write if content changed to avoid triggering Vite's file watcher loop
  const existingContent = await readFile(OUTPUT_FILE, 'utf8').catch(() => '')
  if (existingContent === content) {
    return // No changes, skip write to prevent restart loop
  }

  await writeFile(OUTPUT_FILE, content)
  console.log(`[generate-api-whitelist] Generated ${OUTPUT_FILE}`)
  console.log(`  Components: ${components.length}`)
  console.log(`  Composables: ${composables.length}`)
}

/**
 * Vite plugin that regenerates the API whitelist on build start
 */
export default function generateApiWhitelistPlugin (): Plugin {
  return {
    name: 'generate-api-whitelist',
    async buildStart () {
      await generateApiWhitelist()
    },
  }
}

// Allow running directly
if (import.meta.url === `file://${process.argv[1]}`) {
  generateApiWhitelist()
}
